const bs = require("black-scholes");
const ChainlinkFeed = require("./ChainLinkFeed.js");

let interestRate = 0.0476;

async function blackScholes(strikePrice, unixTimestamp, isCall) {
    let daysTillExpiry = await calcTTE(unixTimestamp);
    let spotPrice = await ChainlinkFeed.getEthSpotPrice();
    let impliedVol = await calcVol(daysTillExpiry)
    let optionType = isCall ? "call" : "put";
    let result = bs.blackScholes(spotPrice, strikePrice, daysTillExpiry / 365, impliedVol, interestRate, optionType);

    return result;
    // console.log(`Option costs ${result} based on a spot price of ${spotPrice} with ${daysTillExpiry} days till expiration and impl vol of ${impliedVol}`);
}

async function calcTTE(unixTimestamp) {
    let difference = unixTimestamp - (Date.now() / 1000);
    let days = difference / 60 / 60 / 24;

    return days;
}

async function calcVol(daysTillExpiry) {
    if(daysTillExpiry === 1) { 
        daysTillExpiry = 2;
    }

    if(daysTillExpiry > priceHistory.length - 1) {
        daysTillExpiry = priceHistory.length - 1;
    }

    const priceChanges = [];

    for (let i = 0; i < daysTillExpiry - 1; i++) {
        priceChanges.push((priceHistory[i + 1] / priceHistory[i]) - 1);
    }

    // Calculate the mean of the differences
    const mean = priceChanges.reduce((sum, value) => sum + value, 0) / priceChanges.length;

    // Calculate the standard deviation of the differences
    const variance = priceChanges.reduce((sum, value) => sum + (value - mean) ** 2, 0) / priceChanges.length;
    const standardDeviation = Math.sqrt(variance);

    return standardDeviation * Math.sqrt(365);
}

let priceHistory = [1517.237183, 1514.869141, 1546.438232, 1650.716797, 1672.00354, 1616.24707, 1631.645874, 1667.059204, 1664.745605, 1643.241577, 1641.792725, 1586.5354, 1567.326538, 1646.15564, 1572.435059, 1598.156494, 1603.105957, 1611.71106, 1556.604248, 1628.251099, 1628.38208, 1627.118164, 1659.75415, 1552.556519, 1515.506958, 1567.846069, 1576.833496, 1552.479492, 1550.706909, 1451.614868, 1417.938477, 1387.932739, 1336.58606, 1321.53894, 1287.359497, 1264.270386, 1269.379028, 1250.438599, 1256.526611, 1214.778809, 1214.656616, 1200.964844, 1196.77124, 1199.232788, 1201.595337, 1189.986084, 1212.791626, 1226.974365, 1218.962036, 1221.14856, 1220.159424, 1218.182129, 1213.599976, 1217.703613, 1167.609863, 1184.71521, 1188.149536, 1168.259399, 1266.353882, 1309.328735, 1320.549194, 1274.619019, 1263.86853, 1266.384155, 1264.28479, 1281.116333, 1232.4375, 1271.653809, 1259.676758, 1280.256592, 1243.334839, 1294.303345, 1276.273926, 1295.688599, 1216.901245, 1170.086182, 1195.126953, 1205.897949, 1198.925903, 1203.983154, 1183.199585, 1135.173462, 1108.353027, 1142.466675, 1218.426758, 1212.300293, 1200.808594, 1215.602539, 1251.736206, 1241.604248, 1221.819214, 1255.268311, 1287.221069, 1299.4646, 1100.1698, 1332.835571, 1568.591309, 1572.234741, 1627.968018, 1645.093384, 1531.541748, 1519.711792, 1579.70459, 1572.714478, 1590.783325, 1619.698486, 1555.477905, 1514.374878, 1566.56665, 1461.665405, 1344.998535, 1363.447021, 1314.299194, 1299.946411, 1283.200928, 1285.744263, 1310.447021, 1331.713623, 1306.296631, 1274.871704, 1297.422119, 1288.123901, 1294.906372, 1279.575684, 1291.337646, 1322.604248, 1315.500488, 1332.516968, 1351.709473, 1352.837158, 1362.126587, 1323.439209, 1276.093506, 1311.644409, 1327.978638, 1335.652344, 1337.410889, 1330.127686, 1335.32019, 1294.216797, 1317.993286, 1328.259521, 1327.680176, 1252.607788, 1324.388184, 1377.541382, 1335.329102, 1469.741699, 1432.447754, 1471.693481, 1634.755005, 1580.787964, 1713.765259, 1761.800049, 1776.203735, 1719.085449, 1635.347656, 1629.906372, 1561.748535, 1617.183228, 1577.641602, 1556.872681, 1577.220459, 1586.176758, 1553.684937, 1523.838867, 1553.037354, 1430.547363, 1491.39502, 1507.782837, 1696.457031, 1657.059204, 1662.769897, 1622.505859, 1619.31897, 1577.003784, 1612.987305, 1847.007813, 1832.999634, 1878.139404, 1904.228149, 1936.802002, 1981.336548, 1957.24646, 1881.224121, 1851.742676, 1703.025024, 1775.516113, 1699.35083, 1691.658081, 1732.254639, 1608.205811, 1618.874512, 1632.945435, 1635.195801, 1681.517334, 1695.969482, 1727.406982, 1725.46814, 1636.232666, 1441.806763, 1445.383423, 1599.476685, 1549.297485, 1537.405151, 1576.749512, 1520.200684, 1542.97522, 1578.717896, 1338.635742, 1352.626465, 1233.12915, 1191.526245, 1113.587158, 1038.19165, 1097.236572, 1168.401611, 1216.978271, 1222.506226, 1237.593384, 1186.973999, 1134.541016, 1151.059082, 1073.766968, 1066.512817, 1059.767334, 1067.298828, 1098.943848, 1144.579224, 1193.680664, 1199.831665, 1243.446899, 1226.844727, 1143.386719, 1051.421875, 1124.824585, 1127.642456, 1127.656494, 993.63678, 1086.519287, 1067.730713, 1233.206421, 1211.662842, 1204.582764, 1445.216553, 1529.663452, 1665.042236, 1789.82605, 1793.572266, 1814.04834, 1859.289673, 1805.204956, 1801.609497, 1775.078613, 1834.150513, 1823.569336, 1942.328003, 1996.441284, 1812.031006, 1757.941772, 1724.922852, 1803.91333, 1944.827881, 1978.982788, 1972.181885, 2043.170166, 1974.518311, 1961.315674, 2018.336182, 1916.656128, 2090.40918, 2022.725952, 2145.706787, 2056.273926, 2014.418213, 1961.701538, 2072.108643, 2343.510986, 2245.43042, 2517.459961, 2636.093018, 2694.979736, 2749.213135, 2940.644775, 2783.476318, 2857.4104, 2827.756104, 2730.186768, 2815.601807, 2936.940918, 2888.929688, 2808.29834, 3009.393555, 2922.732666, 2938.114014, 2964.835693, 2987.480713, 3077.74585, 3104.106445, 3057.606689, 2993.40332, 3062.310303, 3040.916504, 3019.909424, 3118.344238, 3030.376465, 2981.052246, 3211.866943, 3261.91626, 3192.073975, 3233.274658, 3171.691895, 3411.79248, 3521.241211, 3522.833496, 3445.059326, 3449.552246, 3281.642822, 3385.157959, 3401.987793, 3336.634521, 3291.577637, 3143.178955, 3106.671387, 3108.062012, 3031.067139, 2973.131104, 2897.976563, 2860.459229, 2946.25708, 2945.343018, 2814.854492, 2772.055664, 2620.149658, 2590.696045, 2518.94458, 2574.75415, 2559.562988, 2608.048584, 2729.783447, 2576.747559, 2497.77124, 2555.037354, 2664.831055, 2617.156006, 2834.468994, 2950.118408, 2972.485107, 2919.201172, 2621.801758, 2781.111816, 2764.535645, 2598.067139, 2590.359619, 2639.299316, 2573.816162, 2628.648438, 2763.701172, 2785.727539, 2881.481934, 3127.830078, 3179.877197, 2933.479004, 2883.463379, 2917.362793];

module.exports = { blackScholes };